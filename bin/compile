#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2

BUILDPACK_NAME=vips
BIN_DIR=$(cd "$(dirname "$0")"; pwd)
ROOT_DIR=$(dirname "$BIN_DIR")

function topic() {
  echo "-----> $*"
}

binary="${ROOT_DIR}/build/${STACK}.tar.gz"
vendor="${BUILD_DIR}/vendor/vips"

topic "Fetching $binary"
mkdir -p $vendor && tar -xz -f $binary -C $vendor

VIPS_PATH="$vendor/bin"
VIPS_LD_LIBRARY_PATH="$vendor/lib"
VIPS_LIBRARY_PATH="$vendor/lib"
VIPS_CPATH="$vendor/include"
VIPS_CPPPATH="$vendor/include"
VIPS_PKG_CONFIG_PATH="$vendor/lib/pkgconfig"

topic "Writing profile script"
mkdir -p $BUILD_DIR/.profile.d

cat <<EOF > $BUILD_DIR/.profile.d/$BUILDPACK_NAME.sh
export PATH="\$PATH:\$HOME/vendor/vips/bin"
export LD_LIBRARY_PATH="\$LD_LIBRARY_PATH:\$HOME/vendor/vips/lib"
export LIBRARY_PATH="\$LIBRARY_PATH:\$HOME/vendor/vips/lib"
export CPATH="\$CPATH:\$HOME/vendor/vips/include"
export CPPPATH="\$CPPPATH:\$HOME/vendor/vips/include"
export PKG_CONFIG_PATH="\$PKG_CONFIG_PATH:\$HOME/vendor/vips/lib/pkgconfig"
EOF

export PATH="$PATH:${VIPS_PATH}"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:${VIPS_LD_LIBRARY_PATH}"
export LIBRARY_PATH="$LIBRARY_PATH:${VIPS_LIBRARY_PATH}"
export CPATH="$CPATH:${VIPS_CPATH}"
export CPPPATH="$CPPPATH:${VIPS_CPPPATH}"
export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:${VIPS_PKG_CONFIG_PATH}"

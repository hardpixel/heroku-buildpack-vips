#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

BUILDPACK_NAME=vips
BIN_DIR=$(cd "$(dirname "$0")"; pwd)
ROOT_DIR=$(dirname "$BIN_DIR")

function topic() {
  echo "-----> vips: $*"
}

binary="${ROOT_DIR}/build/${STACK}.tar.gz"
vendor="${BUILD_DIR}/vendor/vips"

topic "Vendoring binaries"
mkdir -p $vendor && tar -xz -f $binary -C $vendor

topic "Building runtime environment"
mkdir -p $BUILD_DIR/.profile.d

cat <<EOF > $BUILD_DIR/.profile.d/$BUILDPACK_NAME.sh
export PATH="\$PATH:\$HOME/vendor/vips/bin"
export LD_LIBRARY_PATH="\$LD_LIBRARY_PATH:\$HOME/vendor/vips/lib"
export LIBRARY_PATH="\$LIBRARY_PATH:\$HOME/vendor/vips/lib"
export INCLUDE_PATH="\$INCLUDE_PATH:\$HOME/vendor/vips/include"
export CPATH="\$CPATH:\$HOME/vendor/vips/include"
export CPPPATH="\$CPPPATH:\$HOME/vendor/vips/include"
export PKG_CONFIG_PATH="\$PKG_CONFIG_PATH:\$HOME/vendor/vips/lib/pkgconfig"
EOF

export PATH="$PATH:$vendor/bin"
export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$vendor/lib"
export LIBRARY_PATH="$LIBRARY_PATH:$vendor/lib"
export INCLUDE_PATH="$INCLUDE_PATH:$vendor/include"
export CPATH="$CPATH:$vendor/include"
export CPPPATH="$CPPPATH:$vendor/include"
export PKG_CONFIG_PATH="$PKG_CONFIG_PATH:$vendor/lib/pkgconfig"

# Give environment to later buildpacks
export | grep -E -e ' (PATH|LD_LIBRARY_PATH|LIBRARY_PATH|INCLUDE_PATH|CPATH|CPPPATH|PKG_CONFIG_PATH)=' > "$LP_DIR/export"
